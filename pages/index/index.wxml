<!-- pages/index/index.wxml -->
<view class="container">
  <!-- ç•ªèŒ„é’ŸåŒºåŸŸ -->
  <view class="pomodoro-card card">
    <!-- åœ†å½¢è®¡æ—¶å™¨ -->
    <view class="timer-circle">
      <view class="timer-display">
        <text class="timer-text">{{timerDisplay}}</text>
      </view>
      <canvas class="timer-canvas" canvas-id="timerCanvas"></canvas>
    </view>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <view class="timer-controls">
      <button wx:if="{{timerState === 'idle'}}" class="btn-primary btn-start" bindtap="onStartTimer">
        å¼€å§‹ä¸“æ³¨
      </button>

      <view wx:if="{{timerState === 'running'}}" class="control-buttons">
        <button class="btn-secondary" bindtap="onPauseTimer">æš‚åœ</button>
        <button class="btn-danger" bindtap="onAbandonTimer">æ”¾å¼ƒ</button>
      </view>

      <view wx:if="{{timerState === 'paused'}}" class="control-buttons">
        <button class="btn-primary" bindtap="onResumeTimer">ç»§ç»­</button>
        <button class="btn-danger" bindtap="onAbandonTimer">æ”¾å¼ƒ</button>
      </view>

      <view wx:if="{{timerState === 'break'}}" class="break-info">
        <text class="break-text">ä¼‘æ¯æ—¶é—´</text>
        <button class="btn-secondary btn-skip" bindtap="onSkipBreak">è·³è¿‡ä¼‘æ¯</button>
      </view>
    </view>

    <!-- å½“å‰ä»»åŠ¡æ˜¾ç¤º -->
    <view wx:if="{{currentTask}}" class="current-task">
      <view class="task-info">
        <text class="task-label">å½“å‰ä»»åŠ¡ï¼š</text>
        <text class="task-title">{{currentTask.title}}</text>
      </view>
      <view class="pomodoro-progress">
        <text wx:for="{{currentTask.pomodoroTarget}}" wx:key="index" class="pomodoro-dot {{index < currentTask.pomodoroCompleted ? 'completed' : ''}}">ğŸ…</text>
        <text class="progress-text">({{currentTask.pomodoroCompleted}}/{{currentTask.pomodoroTarget}})</text>
      </view>
    </view>
    <view wx:else class="select-task-hint" bindtap="onSelectTask">
      <text>ç‚¹å‡»é€‰æ‹©ä»»åŠ¡å¼€å§‹ä¸“æ³¨ â†’</text>
    </view>
  </view>

  <!-- ä»Šæ—¥æ¦‚è§ˆ -->
  <view class="today-overview card">
    <view class="overview-title">ä»Šæ—¥æ•°æ®</view>
    <view class="stats-row">
      <view class="stat-item">
        <text class="stat-icon">ğŸ…</text>
        <text class="stat-value">{{todayStats.pomodoroCount}}</text>
        <text class="stat-label">ç•ªèŒ„æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-icon">â±</text>
        <text class="stat-value">{{todayStats.focusMinutes}}</text>
        <text class="stat-label">åˆ†é’Ÿ</text>
      </view>
      <view class="stat-item">
        <text class="stat-icon">âœ…</text>
        <text class="stat-value">{{todayStats.completedTasks}}</text>
        <text class="stat-label">å®Œæˆä»»åŠ¡</text>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡åˆ—è¡¨ -->
  <view class="task-section">
    <view class="section-header">
      <text class="section-title">ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</text>
      <button class="btn-add" bindtap="onAddTask">+ æ–°å»º</button>
    </view>

    <!-- ç­›é€‰å™¨ -->
    <view class="filter-bar">
      <view class="filter-tabs">
        <text class="filter-tab {{filterStatus === 'all' ? 'active' : ''}}" bindtap="onFilterChange" data-status="all">å…¨éƒ¨</text>
        <text class="filter-tab {{filterStatus === 'pending' ? 'active' : ''}}" bindtap="onFilterChange" data-status="pending">å¾…å¼€å§‹</text>
        <text class="filter-tab {{filterStatus === 'in_progress' ? 'active' : ''}}" bindtap="onFilterChange" data-status="in_progress">è¿›è¡Œä¸­</text>
        <text class="filter-tab {{filterStatus === 'completed' ? 'active' : ''}}" bindtap="onFilterChange" data-status="completed">å·²å®Œæˆ</text>
      </view>
    </view>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <view wx:if="{{tasks.length > 0}}" class="task-list">
      <view wx:for="{{tasks}}" wx:key="_id" class="task-item" bindtap="onTaskTap" data-task="{{item}}">
        <view class="task-main">
          <view class="task-left">
            <text class="priority-dot priority-{{item.priority}}">â—</text>
            <text class="task-title {{item.status === 'completed' ? 'completed' : ''}}">{{item.title}}</text>
          </view>
          <view class="task-right">
            <text class="pomodoro-badge">ğŸ… {{item.pomodoroCompleted}}/{{item.pomodoroTarget}}</text>
          </view>
        </view>
        <view class="task-actions">
          <button wx:if="{{item.status !== 'completed'}}" class="btn-action btn-complete" catchtap="onCompleteTask" data-id="{{item._id}}">âœ“ å®Œæˆ</button>
          <button class="btn-action btn-edit" catchtap="onEditTask" data-id="{{item._id}}">ç¼–è¾‘</button>
          <button class="btn-action btn-delete" catchtap="onDeleteTask" data-id="{{item._id}}">åˆ é™¤</button>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:else class="empty-state">
      <text class="empty-icon">ğŸ“</text>
      <text class="empty-text">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå§</text>
    </view>
  </view>
</view>

<!-- ä»»åŠ¡é€‰æ‹©å¼¹çª— -->
<view wx:if="{{showTaskSelector}}" class="modal-mask" catchtap="onCloseTaskSelector">
  <view class="modal-content" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©ä»»åŠ¡</text>
      <text class="modal-close" catchtap="onCloseTaskSelector">âœ•</text>
    </view>
    <view class="modal-body">
      <!-- æ—¶é•¿å¿«é€Ÿé€‰æ‹© -->
      <view class="duration-selector">
        <view class="duration-label">â± æœ¬æ¬¡ç•ªèŒ„æ—¶é•¿</view>
        <view class="duration-options">
          <view class="duration-option {{customDuration === 15 ? 'active' : ''}}" bindtap="onSelectDuration" data-duration="15">
            <text class="duration-text">15</text>
            <text class="duration-unit">åˆ†é’Ÿ</text>
          </view>
          <view class="duration-option {{customDuration === 25 ? 'active' : ''}}" bindtap="onSelectDuration" data-duration="25">
            <text class="duration-text">25</text>
            <text class="duration-unit">åˆ†é’Ÿ</text>
          </view>
          <view class="duration-option {{customDuration === 30 ? 'active' : ''}}" bindtap="onSelectDuration" data-duration="30">
            <text class="duration-text">30</text>
            <text class="duration-unit">åˆ†é’Ÿ</text>
          </view>
          <view class="duration-option {{customDuration === 45 ? 'active' : ''}}" bindtap="onSelectDuration" data-duration="45">
            <text class="duration-text">45</text>
            <text class="duration-unit">åˆ†é’Ÿ</text>
          </view>
          <view class="duration-option {{customDuration === 60 ? 'active' : ''}}" bindtap="onSelectDuration" data-duration="60">
            <text class="duration-text">60</text>
            <text class="duration-unit">åˆ†é’Ÿ</text>
          </view>
        </view>
      </view>

      <view class="task-list-divider"></view>

      <!-- ä»»åŠ¡åˆ—è¡¨ -->
      <view wx:for="{{availableTasks}}" wx:key="_id" class="selector-item" bindtap="onTaskSelected" data-task="{{item}}">
        <text class="priority-dot priority-{{item.priority}}">â—</text>
        <text class="selector-title">{{item.title}}</text>
        <text class="selector-badge">ğŸ… {{item.pomodoroCompleted}}/{{item.pomodoroTarget}}</text>
      </view>
      <view class="selector-item selector-item-add" bindtap="onAddTaskFromSelector">
        <text class="independent-icon">â•</text>
        <text class="selector-title">æ–°å»ºä»»åŠ¡</text>
      </view>
      <view class="selector-item" bindtap="onIndependentPomodoro">
        <text class="independent-icon">ğŸ…</text>
        <text class="selector-title">ç‹¬ç«‹ç•ªèŒ„ï¼ˆä¸ç»‘å®šä»»åŠ¡ï¼‰</text>
      </view>
    </view>
  </view>
</view>

<!-- ç•ªèŒ„å®Œæˆå¼¹çª— -->
<view wx:if="{{showCompletionModal}}" class="modal-mask" catchtap="onCloseCompletionModal">
  <view class="completion-modal" catchtap="onModalContentTap">
    <text class="completion-close" catchtap="onCloseCompletionModal">âœ•</text>
    <view class="completion-icon">ğŸ…</view>
    <view class="completion-title">ç•ªèŒ„å®Œæˆï¼</view>

    <view wx:if="{{currentTask}}" class="task-progress-info">
      <text class="task-progress-label">{{currentTask.title}}</text>
      <view class="task-progress-bar">
        <view class="progress-wrapper">
          <view class="progress-fill" style="width: {{currentTask.pomodoroCompleted / currentTask.pomodoroTarget * 100}}%"></view>
        </view>
        <text class="task-progress-text">{{currentTask.pomodoroCompleted}}/{{currentTask.pomodoroTarget}} ç•ªèŒ„</text>
      </view>
    </view>

    <view class="completion-actions">
      <button wx:if="{{currentTask.pomodoroCompleted >= currentTask.pomodoroTarget}}"
              class="btn-primary completion-btn"
              bindtap="onCompleteTaskFromModal">
        âœ“ å®Œæˆä»»åŠ¡
      </button>
      <button wx:else
              class="btn-primary completion-btn"
              bindtap="onAnotherPomodoro">
        ğŸ… å†æ¥ä¸€ä¸ªç•ªèŒ„é’Ÿ
      </button>
      <button class="btn-secondary completion-btn" bindtap="onCloseCompletionModal">
        ç¨åç»§ç»­
      </button>
    </view>
  </view>
</view>

<!-- ä¼‘æ¯æ—¶é•¿é€‰æ‹©å¼¹çª— -->
<view wx:if="{{showBreakSelector}}" class="modal-mask" catchtap="onCloseBreakSelector">
  <view class="modal-content break-selector-modal" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©ä¼‘æ¯æ—¶é•¿</text>
      <text class="modal-close" catchtap="onCloseBreakSelector">âœ•</text>
    </view>
    <view class="modal-body">
      <!-- ä¼‘æ¯æ—¶é•¿é€‰é¡¹ -->
      <view class="break-duration-options">
        <view class="break-option {{customBreakDuration === 5 ? 'active' : ''}}"
              bindtap="onSelectBreakDuration" data-duration="5">
          <text class="break-icon">â˜•</text>
          <text class="break-duration-text">5</text>
          <text class="break-duration-unit">åˆ†é’Ÿ</text>
          <text class="break-label">çŸ­ä¼‘æ¯</text>
        </view>
        <view class="break-option {{customBreakDuration === 10 ? 'active' : ''}}"
              bindtap="onSelectBreakDuration" data-duration="10">
          <text class="break-icon">â˜•</text>
          <text class="break-duration-text">10</text>
          <text class="break-duration-unit">åˆ†é’Ÿ</text>
          <text class="break-label">æ ‡å‡†ä¼‘æ¯</text>
        </view>
        <view class="break-option {{customBreakDuration === 15 ? 'active' : ''}}"
              bindtap="onSelectBreakDuration" data-duration="15">
          <text class="break-icon">ğŸŒ™</text>
          <text class="break-duration-text">15</text>
          <text class="break-duration-unit">åˆ†é’Ÿ</text>
          <text class="break-label">é•¿ä¼‘æ¯</text>
        </view>
        <view class="break-option {{customBreakDuration === 20 ? 'active' : ''}}"
              bindtap="onSelectBreakDuration" data-duration="20">
          <text class="break-icon">ğŸŒ™</text>
          <text class="break-duration-text">20</text>
          <text class="break-duration-unit">åˆ†é’Ÿ</text>
          <text class="break-label">é•¿ä¼‘æ¯</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="break-actions">
        <button class="btn-primary break-action-btn" bindtap="onConfirmBreak">
          å¼€å§‹ä¼‘æ¯
        </button>
        <button class="btn-secondary break-action-btn" bindtap="onSkipBreakFromSelector">
          è·³è¿‡ä¼‘æ¯
        </button>
      </view>
    </view>
  </view>

  <!-- æ–°ç”¨æˆ·æ¬¢è¿å¼•å¯¼å¼¹çª— -->
  <view wx:if="{{showWelcomeModal}}" class="modal-mask">
    <view class="welcome-modal" catchtap="onModalContentTap">
      <!-- æ¬¢è¿å›¾æ ‡ -->
      <view class="welcome-header">
        <text class="welcome-icon">ğŸ‰</text>
        <view class="welcome-title">æ¬¢è¿ä½¿ç”¨ TimeFocus</view>
        <view class="welcome-subtitle">è®¾ç½®ä½ çš„å¤´åƒå’Œæ˜µç§°ï¼Œå¼€å¯é«˜æ•ˆä¸“æ³¨ä¹‹æ—…</view>
      </view>

      <!-- è®¾ç½®è¡¨å• -->
      <view class="welcome-form">
        <!-- å¤´åƒé€‰æ‹© -->
        <view class="welcome-avatar-section">
          <button class="welcome-avatar-btn" open-type="chooseAvatar" bindchooseavatar="onWelcomeChooseAvatar">
            <image wx:if="{{tempAvatar}}" class="welcome-avatar-preview" src="{{tempAvatar}}" mode="aspectFill"></image>
            <view wx:else class="welcome-avatar-placeholder">
              <text class="welcome-avatar-icon">ğŸ“·</text>
              <text class="welcome-avatar-text">ç‚¹å‡»é€‰æ‹©å¤´åƒ</text>
            </view>
          </button>
        </view>

        <!-- æ˜µç§°è¾“å…¥ -->
        <view class="welcome-nickname-section">
          <view class="welcome-input-label">æ˜µç§°</view>
          <input
            class="welcome-nickname-input"
            type="nickname"
            placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°"
            placeholder-style="line-height: 44rpx;"
            bindinput="onWelcomeNicknameInput"
            value="{{tempNickname}}"
          />
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="welcome-actions">
        <button wx:if="{{tempNickname}}" class="btn-primary welcome-action-btn" bindtap="onCompleteWelcome">
          å®Œæˆè®¾ç½®
        </button>
        <button class="btn-secondary welcome-action-btn" bindtap="onSkipWelcome">
          ç¨åè®¾ç½®
        </button>
      </view>
    </view>
  </view>
</view>
