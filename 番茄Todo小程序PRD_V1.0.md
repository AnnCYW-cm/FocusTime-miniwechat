# 🍅 番茄Todo - 微信小程序产品需求文档 (PRD)

**版本：** V1.0  
**日期：** 2024年12月  

---

## 1. 产品概述

### 1.1 产品背景

在信息爆炸的时代，专注力成为稀缺资源。番茄工作法作为一种经过验证的时间管理方法，能有效帮助用户提升工作效率。本产品将任务管理与番茄钟相结合，帮助用户更好地规划任务、追踪专注时间、分析工作效率。

### 1.2 产品定位

一款结合任务管理与番茄钟的微信小程序，支持微信登录、多设备同步、历史数据统计，帮助用户科学管理时间、提升专注力。

### 1.3 核心价值

- 任务与番茄钟深度绑定，每个任务的时间投入清晰可见
- 微信一键登录，数据云端同步，换设备数据不丢失
- 丰富的统计图表，帮助用户复盘和优化工作习惯
- 可自定义番茄时长，适应不同工作场景

---

## 2. 用户画像

### 2.1 目标用户

| 用户类型 | 特征描述 | 核心需求 |
|---------|---------|---------|
| 职场白领 | 25-40岁，需要处理多项工作任务 | 任务优先级管理、专注时间统计 |
| 学生群体 | 18-25岁，备考或日常学习 | 学习计划管理、学习时长记录 |
| 自由职业者 | 需要自我管理工作进度 | 项目时间追踪、效率分析 |
| 效率爱好者 | 追求个人成长和时间管理 | 习惯养成、数据可视化 |

### 2.2 使用场景

1. **工作场景**：规划今日待办，逐个番茄完成，下班前查看效率报告
2. **学习场景**：设置学习任务和目标番茄数，定时休息，避免疲劳学习
3. **复盘场景**：周末查看本周专注时长，分析时间分配，优化下周计划

---

## 3. 功能模块

### 3.1 用户系统

#### 3.1.1 功能描述

基于微信生态的用户认证系统，实现一键登录和用户数据管理。

#### 3.1.2 功能清单

| 功能项 | 功能说明 | 验收标准 | 优先级 |
|-------|---------|---------|-------|
| 微信登录 | 调用wx.login获取用户openid，自动创建/关联账户 | 首次进入自动静默登录，无需手动操作 | P0 必须 |
| 获取头像昵称 | 通过button组件获取用户头像和昵称 | 用户主动授权后显示真实头像昵称 | P1 重要 |
| 个人信息页 | 展示用户基本信息、累计数据 | 显示总番茄数、总专注时长、总完成任务数、注册天数（数据来源于 3.4 统计模块的累计口径） | P1 重要 |
| 退出登录 | 清除本地缓存的头像昵称等信息，返回「我的」页默认态 | 退出后显示默认头像和「点击登录」；下次打开仍通过 wx.login 静默登录 | P2 一般 |

#### 3.1.3 业务流程

```
用户打开小程序 → 检查登录态 → 已登录则进入首页
                              ↓ 未登录
                    调用wx.login静默登录 → 获取openid
                              ↓
                    查询用户是否存在 → 存在则登录成功
                              ↓ 不存在
                         创建新用户 → 进入首页
```

---

### 3.2 任务管理

#### 3.2.1 功能描述

完整的任务CRUD功能，支持任务分类、优先级设置、番茄目标设定，任务与番茄钟深度关联。

#### 3.2.2 功能清单

| 功能项 | 功能说明 | 验收标准 | 优先级 |
|-------|---------|---------|-------|
| 创建任务 | 输入标题、描述、选择优先级、设置目标番茄数 | 必填标题，其他可选，创建后即时显示在列表 | P0 必须 |
| 编辑任务 | 修改任务的所有属性 | 修改后即时生效，已完成番茄数不可修改 | P0 必须 |
| 删除任务 | 删除单个任务。删除后：保留历史番茄记录；将番茄记录中的 taskId 置空（解绑）；番茄仍计入总量统计，但不计入任务维度统计 | 删除后：①任务不再出现在任务列表及任务统计中；②历史番茄记录仍可在记录列表/时间维度统计中查看；③被解绑的番茄 taskId 为空；④今日/本周专注时长、番茄数等总量统计不变 | P0 必须 |
| 完成任务 | 标记任务为已完成状态 | 点击勾选即完成，可撤销恢复为进行中 | P0 必须 |
| 任务筛选 | 按状态、优先级筛选任务 | 支持全部/进行中/已完成三种状态筛选 | P1 重要 |
| 任务排序 | 按创建时间、优先级、番茄进度排序 | 默认按创建时间倒序，可切换排序方式 | P2 一般 |
| 标签管理 | 为任务添加自定义标签 | 支持多标签，可按标签筛选 | P2 一般 |

#### 3.2.3 任务数据结构

> 本节为任务的**关键业务字段**说明，完整字段及类型以 5.2 `tasks` 集合设计为准。

| 字段名 | 类型 | 必填 | 说明 |
|-------|-----|-----|------|
| title | String | 是 | 任务标题，最多50字 |
| description | String | 否 | 任务描述，最多200字 |
| priority | Enum | 是 | high / medium / low |
| tags | Array | 否 | 标签数组，最多5个 |
| status | Enum | 是 | pending / in_progress / completed |
| pomodoroTarget | Number | 是 | 目标番茄数，默认1 |
| pomodoroCompleted | Number | 是 | 已完成番茄数 |
| dueDate | Date | 否 | 截止日期 |
| createdAt | Date | 是 | 创建时间 |
| completedAt | Date | 否 | 完成时间，仅在 status = completed 时有值 |

#### 3.2.4 业务规则

**任务状态转换：**

- 新建任务默认 `status = pending`
- 当任务**首次被绑定番茄并启动计时**时，自动变为 `in_progress`
- 只有用户**手动勾选「完成任务」**时才变为 `completed`
- 番茄数达到目标（`pomodoroCompleted ≥ pomodoroTarget`）**不会自动**把任务标记完成，避免歧义
- 已完成任务可撤销，状态恢复为 `in_progress`（若从未启动过番茄则恢复为 `pending`）
- **允许从 `pending` 直接勾选完成**，此时 `pomodoroCompleted` 可为 0（适用于不需要番茄的小任务）

```
pending ──(首次启动番茄)──→ in_progress ──(手动勾选完成)──→ completed
   │                              ↑                           │
   └──────(直接勾选完成)──────────→│←──────(撤销完成)───────────┘
```

**completedAt 字段维护规则：**

- 当用户手动勾选「完成任务」时：将 `status` 设为 `completed`，同时将 `completedAt` 设为当前时间
- 当用户撤销完成时：将 `status` 设回 `in_progress`，同时将 `completedAt` 置空（`null`）
- 「完成任务数」统计口径：统计周期内 `completedAt` 落在该时间段内的任务数量（无需分析状态变更历史）

**pomodoroCompleted 字段维护规则：**

- 每次完成一个**绑定该任务且 isCompleted = true** 的番茄时，该任务的 `pomodoroCompleted + 1`
- `pomodoroCompleted` 仅作为快速查询/展示用，**以 `pomodoro_logs` 为权威数据源**
- 如出现不一致，以 `pomodoro_logs` 重新计算为准（可在后台提供修复脚本）

---

### 3.3 番茄钟

#### 3.3.1 功能描述

核心计时功能，支持自定义时长、任务绑定、后台计时、完成提醒。番茄完成后自动记录到数据库。

#### 3.3.2 功能清单

| 功能项 | 功能说明 | 验收标准 | 优先级 |
|-------|---------|---------|-------|
| 开始计时 | 点击开始按钮启动倒计时 | 显示倒计时动画，秒级精度 | P0 必须 |
| 暂停/继续 | 暂停当前计时，可继续 | 暂停时保持当前时间，继续后接着倒计时 | P0 必须 |
| 放弃番茄 | 中途放弃当前番茄 | 二次确认后重置，不计入完成记录 | P0 必须 |
| 绑定任务 | 选择要专注的任务 | 完成后该任务番茄数+1 | P0 必须 |
| 独立番茄 | 不绑定任务的自由计时 | 记录到历史但不关联任务 | P1 重要 |
| 完成提醒 | 番茄完成时震动+弹窗 | 前台弹窗提示，震动反馈 | P0 必须 |
| 后台计时 | 小程序切到后台继续计时 | 返回时显示正确剩余时间 | P1 重要 |
| 休息计时 | 番茄完成后自动进入休息倒计时 | 短休息5分钟，每4个番茄后长休息15分钟；**休息计时不写入 `pomodoro_logs`，仅用于引导放松，不参与任何统计** | P1 重要 |
| 自定义时长 | 在设置中调整番茄/休息时长 | 番茄5-60分钟可调，休息1-30分钟可调 | P1 重要 |

#### 3.3.3 番茄钟状态机

```
状态定义：
- idle（空闲）：初始状态，可开始新番茄
- running（运行中）：倒计时进行中
- paused（已暂停）：暂停状态，可继续或放弃
- break（休息中）：休息倒计时

状态转换：
idle → running（开始）
running ←→ paused（暂停/继续）
running → break（完成）
running → idle（放弃）
paused → idle（放弃）
break → idle（休息结束）
```

**放弃番茄规则：**

- 支持在 `running` 和 `paused` 两种状态下触发
- 触发后统一进入 `idle` 状态，按 3.3.4 的规则清理本地计时状态，**不写入 `pomodoro_logs`**

#### 3.3.4 计时实现策略

**后台计时与异常处理：**

- **前台计时**：使用本地倒计时展示，秒级刷新
- **时间记录**：每次开始/继续计时时，记录 `startedAt`（开始时间戳）和 `plannedDuration`（计划时长）
- **后台恢复**：回到前台时，通过「当前时间 - startedAt」重新计算剩余时长，避免后台倒计时误差
- **进程被杀后的处理**：
  - 若小程序被系统彻底杀死后重新打开：
  - 检测到有未完成的计时记录时：
    - 如果 `当前时间 ≥ startedAt + plannedDuration`：视为该番茄已完成，自动写入完成记录
    - 否则视为「中断未完成」，清除计时状态，不写入记录

**本地持久化字段（用于恢复计时状态）：**

| 字段 | 说明 |
|-----|------|
| timerState | 计时状态：idle / running / paused / break |
| startedAt | 本次计时开始时间戳 |
| plannedDuration | 计划时长（分钟） |
| boundTaskId | 绑定的任务 ID（可为空） |
| pausedRemaining | 暂停时的剩余秒数（仅 paused 状态有值） |

**本地计时状态清理时机：**

以下场景需清理本地计时状态（将 `timerState` 置为 `idle` 并清空其他字段）：

- 番茄正常完成并成功写入 `pomodoro_logs` 后
- 用户点击「放弃番茄」并确认后
- 小程序重启时检测到「中断未完成」并清除计时状态时
- 休息倒计时结束后（若未开启自动开始下一个番茄）

---

### 3.4 数据统计

#### 3.4.1 功能描述

多维度统计分析用户的专注数据，包括今日概览、趋势图表、历史记录查询，帮助用户了解和优化工作习惯。

#### 3.4.2 功能清单

| 功能项 | 功能说明 | 验收标准 | 优先级 |
|-------|---------|---------|-------|
| 今日概览 | 显示今日概览数据 | 番茄数、专注时长、完成任务数 | P0 必须 |
| 周统计 | 最近7天每日番茄数柱状图 | 展示含今天在内的最近7天数据，可左右滑动查看更早的7天窗口 | P1 重要 |
| 月统计 | 本月日历热力图 | 颜色深浅表示当天番茄数多少 | P1 重要 |
| 历史记录 | 按日期查看番茄记录列表 | 显示每个番茄的开始时间、时长、关联任务 | P1 重要 |
| 任务统计 | 按任务维度统计番茄投入 | 显示每个任务累计番茄数和时长 | P2 一般 |
| 累计数据 | 用户使用至今的总数据 | 总番茄数、总时长、总完成任务数 | P1 重要 |

#### 3.4.3 统计指标定义

| 指标 | 计算方式 |
|-----|---------|
| 番茄数 | 统计周期内 `isCompleted = true` 的记录数 |
| 专注时长 | 统计周期内所有 `isCompleted = true` 的番茄 `duration` 字段求和 |
| 完成任务数 | 统计周期内 `completedAt` 落在该时间段内的任务数 |
| 平均日番茄 | 统计周期内总番茄数 / 自然天数（包括没有番茄的日期） |

**统计口径说明：**

- `duration` 字段含义：**实际专注时长**（`endedAt - startedAt` 的结果，向下取整到分钟）
- **放弃番茄不落库**：用户中途放弃的番茄不写入 `pomodoro_logs`，不计入任何统计
- 只有完整完成（`isCompleted = true`）的番茄才计入「番茄数」和「专注时长」统计
- **完成任务数一律以 `completedAt` 为准**，无需分析状态变更历史

#### 3.4.4 删除任务对统计的影响

- 删除任务**不会影响**历史番茄的总量及专注总时长等时间维度统计
- 已删除任务关联的番茄记录，**仅在任务维度统计中被排除**（因 taskId 已置空）
- 删除任务**不会回退已统计的「总完成任务数」**，该指标作为历史累计值，仅依赖 `completedAt` 是否曾经存在，与任务当前是否被删除无关

**删除任务后的 UI 展示规则：**

- 历史番茄记录列表中：
  - 若 `taskId` 为空但 `taskTitle` 仍有值：显示「{taskTitle}（已删除）」
  - 若 `taskId` 为空且 `taskTitle` 也为空：显示「独立番茄」

---

### 3.5 设置中心

#### 3.5.1 功能描述

用户个性化配置中心，包括番茄钟参数、提醒方式、账号管理等设置。

> **版本说明**：本节列出完整设置项清单，实际上线版本按 7. 版本规划分批实现：
> - V1.0 仅实现「番茄时长」
> - 其他设置项（休息时长、自动开始等）在 V1.2 中补齐

#### 3.5.2 设置项清单

| 设置项 | 类型 | 默认值 | 范围/说明 |
|-------|-----|-------|---------|
| 番茄时长 | 滑块 | 25分钟 | 5-60分钟 |
| 短休息时长 | 滑块 | 5分钟 | 1-15分钟 |
| 长休息时长 | 滑块 | 15分钟 | 10-30分钟 |
| 长休息间隔 | 选择器 | 4个番茄 | 2-6个 |
| 完成震动 | 开关 | 开启 | 番茄完成时震动 |
| 完成提示音 | 开关 | 开启 | 番茄完成时播放提示音 |
| 自动开始休息 | 开关 | 关闭 | 番茄完成后自动开始休息 |
| 自动开始下一个 | 开关 | 关闭 | 休息结束后自动开始番茄 |

---

## 4. 页面设计

### 4.1 页面结构

| 页面 | 路径 | 功能说明 |
|-----|-----|---------|
| 首页 | pages/index/index | 任务列表 + 番茄钟 + 今日概览 |
| 历史记录 | pages/history/history | 按日期查看番茄记录 |
| 统计页 | pages/statistics/statistics | 周/月统计图表 |
| 我的 | pages/profile/profile | 个人信息 + 设置入口 |
| 任务详情 | pages/task-detail/task-detail | 任务创建/编辑页 |
| 设置页 | pages/settings/settings | 番茄钟参数设置 |

### 4.2 首页布局

```
┌─────────────────────────────────────┐
│  🍅 番茄Todo              [⚙️]     │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │         🍅                  │   │
│  │        24:59                │   │
│  │                             │   │
│  │     [开始]  [放弃]          │   │
│  │                             │   │
│  │     当前: 完成PRD文档       │   │
│  │     🍅🍅⚪⚪ (2/4)          │   │
│  └─────────────────────────────┘   │
│                                     │
│  今日: 🍅×4  ⏱98分钟  ✅3任务      │
├─────────────────────────────────────┤
│  📋 任务列表            [+ 新建]   │
│  ┌─────────────────────────────┐   │
│  │ 🔴 完成PRD文档       🍅2/4  │   │
│  │ 🟡 回复邮件          🍅0/2  │   │
│  │ 🟢 整理笔记          🍅1/1  │   │
│  │ ✅ 晨会             🍅1/1  │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  [首页]  [历史]  [统计]  [我的]    │
└─────────────────────────────────────┘
```

首页采用上中下三段式布局：

1. **顶部**：番茄钟区域（圆形计时器 + 控制按钮 + 当前任务）
2. **中部**：今日概览卡片（番茄数、时长、任务数）
3. **底部**：任务列表（可滚动、支持新建和筛选）

### 4.3 设计规范

| 设计元素 | 规范说明 |
|---------|---------|
| 主题色 | `#E74C3C`（番茄红） |
| 背景色 | `#FDF6F0`（暖米色） |
| 成功色 | `#27AE60`（完成绿） |
| 文字色 | 主文字 `#2C3E50`，次文字 `#7F8C8D` |
| 圆角 | 卡片 16rpx，按钮 24rpx |
| 间距 | 页面边距 32rpx，卡片间距 24rpx |

### 4.4 空状态设计

| 场景 | 展示内容 |
|-----|---------|
| 首次使用无任务 | 插画 + 「还没有任务，点击下方按钮创建第一个吧」 |
| 今日概览无记录 | 今日概览卡片显示「🍅×0  ⏱0分钟  ✅0任务」+ 副文案「选择一个任务开始专注吧」 |
| 历史记录为空 | 「暂无记录，完成番茄后这里会显示你的专注历史」 |
| 统计页无数据 | 「数据积累中，坚持几天后来看看你的专注趋势吧」 |

---

## 5. 数据库设计

使用微信云开发云数据库（MongoDB），共4个集合。

### 5.1 users 集合（用户信息）

| 字段 | 类型 | 必填 | 说明 |
|-----|-----|-----|------|
| _id | String | 是 | 文档ID，自动生成 |
| _openid | String | 是 | 微信openid，自动注入 |
| nickName | String | 否 | 用户昵称 |
| avatarUrl | String | 否 | 头像URL |
| createdAt | Date | 是 | 注册时间 |
| updatedAt | Date | 是 | 更新时间 |

### 5.2 tasks 集合（任务）

| 字段 | 类型 | 必填 | 说明 |
|-----|-----|-----|------|
| _id | String | 是 | 文档ID |
| _openid | String | 是 | 所属用户 |
| title | String | 是 | 任务标题 |
| description | String | 否 | 任务描述 |
| priority | String | 是 | high / medium / low |
| tags | Array | 否 | 标签数组 |
| status | String | 是 | pending / in_progress / completed |
| pomodoroTarget | Number | 是 | 目标番茄数 |
| pomodoroCompleted | Number | 是 | 已完成番茄数 |
| dueDate | Date | 否 | 截止日期 |
| createdAt | Date | 是 | 创建时间 |
| updatedAt | Date | 是 | 更新时间 |
| completedAt | Date | 否 | 完成时间 |

### 5.3 pomodoro_logs 集合（番茄记录）

| 字段 | 类型 | 必填 | 说明 |
|-----|-----|-----|------|
| _id | String | 是 | 文档ID |
| _openid | String | 是 | 所属用户 |
| taskId | String | 否 | 关联任务ID，可为空。为空表示「独立番茄」或任务已删除后解绑的历史记录 |
| taskTitle | String | 否 | 任务标题（冗余存储） |
| duration | Number | 是 | 时长（分钟） |
| startedAt | Date | 是 | 开始时间 |
| endedAt | Date | 是 | 结束时间 |
| isCompleted | Boolean | 是 | 是否完整完成 |
| note | String | 否 | 备注（预留字段，V1.0 不提供前端入口） |

### 5.4 user_settings 集合（用户设置）

> 每个用户在 `user_settings` 中**最多一条记录**，以 `_openid` 作为主键。首次进入小程序时，若无记录则创建一条默认配置（使用 `upsert` 语义）。

| 字段 | 类型 | 默认值 | 说明 |
|-----|-----|-------|------|
| _openid | String | - | 用户标识（主键） |
| pomodoroDuration | Number | 25 | 番茄时长（分钟） |
| shortBreak | Number | 5 | 短休息时长 |
| longBreak | Number | 15 | 长休息时长 |
| longBreakInterval | Number | 4 | 长休息间隔 |
| soundEnabled | Boolean | true | 提示音开关 |
| vibrationEnabled | Boolean | true | 震动开关 |
| autoStartBreak | Boolean | false | 自动开始休息 |
| autoStartPomodoro | Boolean | false | 自动开始下个番茄 |
| createdAt | Date | - | 创建时间 |
| updatedAt | Date | - | 更新时间 |

### 5.5 数据库安全规则

> 以下为伪代码规则示意，实际语法以[微信云开发安全规则文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/security-rules.html)为准。

```json
{
  "users": {
    ".read": "auth.openid == doc._openid",
    ".write": "auth.openid == doc._openid"
  },
  "tasks": {
    ".read": "auth.openid == doc._openid",
    ".write": "auth.openid == doc._openid"
  },
  "pomodoro_logs": {
    ".read": "auth.openid == doc._openid",
    ".write": "auth.openid == doc._openid"
  },
  "user_settings": {
    ".read": "auth.openid == doc._openid",
    ".write": "auth.openid == doc._openid"
  }
}
```

---

## 6. 非功能需求

### 6.1 性能要求

| 指标 | 要求 |
|-----|-----|
| 首屏加载 | ≤ 2秒 |
| 接口响应 | ≤ 500ms（云函数） |
| 计时精度 | 误差 ≤ 1秒/分钟 |
| 列表渲染 | 100条任务内流畅滚动 |

### 6.2 兼容性要求

- 微信基础库版本 ≥ 2.20.0
- 支持 iOS 11+ 和 Android 6.0+
- 适配 iPhone SE 到 iPhone 15 Pro Max
- 适配主流 Android 机型（华为、小米、OPPO、vivo）

### 6.3 安全要求

- 数据库安全规则：用户只能读写自己的数据
- 敏感操作（删除）需二次确认
- 用户数据传输使用 HTTPS 加密

---

## 7. 版本规划

> **优先级与版本对应规则：**
> - **V1.0** = 所有 P0 功能 + 部分核心 P1 功能（今日概览、基础设置）
> - **V1.1** = 统计相关 P1 功能（周/月统计、历史记录、筛选排序）
> - **V1.2** = 体验优化 P1 + 全部 P2 功能（休息倒计时、标签管理、完整设置项）

### 7.1 V1.0 MVP版本

核心功能闭环，预计开发周期：**2周**

1. 微信登录
2. 任务CRUD（创建、编辑、删除、完成）
3. 番茄钟计时（开始、暂停、放弃、完成）
4. 任务绑定番茄钟
5. 今日统计概览
6. 基础设置（番茄时长）

### 7.2 V1.1 统计增强版

完善数据统计，预计开发周期：**1周**

1. 周统计图表
2. 月度热力图
3. 历史记录查询
4. 任务筛选和排序

### 7.3 V1.2 体验优化版

提升用户体验，预计开发周期：**1周**

1. 休息倒计时
2. 标签管理
3. 后台计时优化
4. 完整设置项

---

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|-----|------|
| 番茄钟 | 一个专注时间单位，默认25分钟 |
| 番茄工作法 | Francesco Cirillo发明的时间管理方法 |
| 云开发 | 微信提供的Serverless开发模式 |
| openid | 微信用户在小程序中的唯一标识 |

### 8.2 参考资料

- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [番茄工作法官网](https://francescocirillo.com/products/the-pomodoro-technique)

---

*— 文档结束 —*
