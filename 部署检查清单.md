# 🚀 前后端联通部署检查清单

## 当前状态

### ✅ 已完成
- [x] 创建了 4 个云函数代码文件
  - login（已存在）
  - statistics（新增）
  - exportData（新增）
  - batchOperations（新增）
- [x] 完善了前端 utils/db.js
- [x] 添加了云函数调用封装
- [x] 完善了数据校验和错误处理

### ⚠️ 需要完成（才能完全联通）

#### 1. 部署云函数 ⭐ 重要
**操作步骤**：
1. 打开微信开发者工具
2. 在左侧找到 `cloudfunctions` 目录
3. 右键点击以下云函数文件夹：
   - `statistics`
   - `exportData`
   - `batchOperations`
4. 选择 **"上传并部署：云端安装依赖"**
5. 等待部署完成（约1-2分钟）

**验证方法**：
```
1. 打开云开发控制台
2. 点击"云函数"标签
3. 应该看到 4 个云函数：login, statistics, exportData, batchOperations
4. 状态都是"已部署"
```

#### 2. 配置数据库权限（如果还没配置）
**操作步骤**：
1. 打开云开发控制台
2. 点击"数据库"标签
3. 确认有以下 4 个集合：
   - users
   - tasks
   - pomodoro_logs
   - user_settings
4. 点击每个集合的"权限设置"
5. 选择"自定义安全规则"
6. 设置为：
   ```json
   {
     "read": "doc._openid == auth.openid",
     "write": "doc._openid == auth.openid"
   }
   ```

#### 3. （可选）创建数据库索引
**操作步骤**：
参考 `database_permissions.md` 创建建议的索引

---

## 🧪 测试联通

### 方法1: 运行测试文件
1. 打开微信开发者工具
2. 在控制台中输入：
   ```javascript
   require('./test_backend.js')
   ```
3. 查看测试结果

### 方法2: 手动测试

#### 测试登录（应该已经工作）
查看控制台，应该有：
```
🔐 开始调用 login 云函数...
✅ 登录成功！
📱 获取到 openid: xxx
```

#### 测试统计云函数
在控制台输入：
```javascript
const { cloudFunctions } = require('./utils/db.js')
cloudFunctions.getStatistics('overview').then(res => {
  console.log('统计数据:', res.data)
})
```

**预期结果**：
```javascript
{
  totalPomodoros: 0,
  totalHours: 0,
  completedTasks: 0,
  totalTasks: 0,
  registerDays: 0,
  avgDaily: 0,
  completionRate: 0
}
```

#### 测试数据导出云函数
在控制台输入：
```javascript
const { cloudFunctions } = require('./utils/db.js')
cloudFunctions.exportData('statistics', 'json').then(res => {
  console.log('导出成功:', res.data)
})
```

#### 测试数据库操作
在控制台输入：
```javascript
const { taskDB } = require('./utils/db.js')
taskDB.list({}).then(res => {
  console.log('任务列表:', res.data)
})
```

---

## 常见问题排查

### 问题1: 云函数调用失败
**错误信息**: `cloud.callFunction:fail`

**可能原因**：
1. ❌ 云函数未部署
2. ❌ 云函数名称写错
3. ❌ 云开发环境ID错误

**解决方法**：
1. 检查云开发控制台，确认云函数已部署
2. 检查 app.js 中的环境ID: `cloud1-3gviboroffb9458b`
3. 重新部署云函数

### 问题2: 数据库权限错误
**错误信息**: `database permission denied`

**可能原因**：
1. ❌ 数据库权限未配置
2. ❌ 未登录（openid 未获取）

**解决方法**：
1. 按上面的步骤配置数据库权限
2. 确认登录成功（查看控制台日志）

### 问题3: 登录失败
**错误信息**: `login 云函数调用失败`

**可能原因**：
1. ❌ login 云函数未部署
2. ❌ 云开发环境ID错误

**解决方法**：
1. 检查 login 云函数是否已部署
2. 检查 app.js 中的环境ID

---

## ✅ 完全联通的标志

当以下条件全部满足时，前后端就完全联通了：

1. ✅ 小程序启动后，控制台显示"✅ 登录成功！"
2. ✅ 能创建任务，数据库中能看到记录
3. ✅ 能调用统计云函数，返回正确数据
4. ✅ 能调用导出云函数，返回正确数据
5. ✅ 所有页面功能正常使用

---

## 📞 需要帮助？

如果遇到问题：
1. 查看控制台错误信息
2. 查看云函数日志（云开发控制台 → 云函数 → 日志）
3. 检查数据库权限配置
4. 运行 `test_backend.js` 测试文件

---

## 下一步

联通成功后，可以：
1. 在"统计"页面添加更丰富的图表（使用 statistics 云函数）
2. 在"我的"页面添加数据导出功能（使用 exportData 云函数）
3. 添加批量管理任务的功能（使用 batchOperations 云函数）
