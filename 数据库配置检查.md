# 📋 数据库配置检查清单

如果遇到"加载失败"、"任务不存在"等错误，请按照以下步骤检查：

## ✅ 第一步：检查云开发环境

1. **打开微信开发者工具**
2. 点击顶部工具栏的 **"云开发"** 按钮
3. 确认环境ID为：`cloud1-3gviboroffb9458b`
4. 确认云开发已经开通并初始化

## ✅ 第二步：创建数据库集合

在云开发控制台的"数据库"标签中，需要创建以下4个集合：

### 1. `tasks`（任务列表）✨ 最重要
如果编辑任务时提示"加载失败"，很可能是这个集合还没创建或权限配置错误。

**创建步骤**：
1. 点击"添加集合"
2. 集合名称输入：`tasks`
3. 点击创建

### 2. `users`（用户信息）
用于存储用户昵称、头像等信息

### 3. `pomodoro_logs`（番茄记录）
用于存储每次番茄钟的专注记录

### 4. `user_settings`（用户设置）
用于存储用户的个性化设置

## ✅ 第三步：配置数据库权限

**非常重要！** 每个集合都需要配置权限，否则无法读取数据。

### tasks 集合权限配置：

1. 在数据库列表中找到 `tasks` 集合
2. 点击右侧的"权限设置"
3. 选择"自定义安全规则"
4. 粘贴以下配置：

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

5. 点击"保存"

### 其他集合权限配置

`users`、`pomodoro_logs`、`user_settings` 三个集合也需要配置相同的权限：

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

## ✅ 第四步：验证配置

### 方法1：查看控制台日志

1. 在微信开发者工具中打开"调试器"
2. 切换到"Console"标签
3. 尝试创建一个任务，然后编辑它
4. 查看是否有错误信息

### 常见错误信息：

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `permission denied` | 权限配置错误 | 检查第三步的权限配置 |
| `collection not found` | 集合不存在 | 检查第二步，创建对应集合 |
| `doc not found` | 任务不存在 | 可能任务已被删除 |
| `network error` | 网络问题 | 检查网络连接 |

### 方法2：使用内置测试功能

1. 在小程序中进入"我的"页面
2. 点击"🧪 测试后端连接"按钮
3. 查看测试结果

## ✅ 第五步：创建测试数据

如果配置正确但仍有问题，可以尝试：

1. 创建一个新任务
2. 立即尝试编辑该任务
3. 如果新任务可以编辑，说明配置正确
4. 如果旧任务无法编辑，可能是数据格式问题

## 🆘 常见问题解答

### Q1: 为什么我的任务列表是空的？
**A**: 这是正常的！因为权限配置是"仅创建者可读写"，所以：
- 每个用户只能看到自己创建的任务
- 首次使用需要手动创建任务

### Q2: 点击编辑任务时提示"加载失败"？
**A**: 最常见的原因是：
1. tasks 集合还没创建 → 按第二步创建
2. tasks 集合权限未配置 → 按第三步配置
3. 网络问题 → 检查网络连接

### Q3: 如何确认权限配置成功？
**A**: 在云开发控制台中：
1. 进入"数据库"
2. 点击 tasks 集合
3. 点击"权限设置"
4. 查看规则是否为自定义的配置

### Q4: 我不小心配置错了，怎么办？
**A**: 没关系，重新配置即可：
1. 打开该集合的权限设置
2. 修改配置
3. 点击保存
4. 重启小程序测试

## 📞 技术支持

如果按照以上步骤仍然无法解决问题，请：

1. **查看控制台完整错误信息**
   - 打开微信开发者工具
   - 查看 Console 中的红色错误
   - 记录完整的错误消息

2. **检查云开发配额**
   - 进入云开发控制台
   - 查看"概览"页面
   - 确认数据库读写次数未超限

3. **尝试清除缓存**
   - 在开发者工具中点击"清缓存"
   - 选择"清除数据缓存"
   - 重新编译运行

## 🎯 快速诊断脚本

复制以下代码到任意页面的 onLoad 中运行诊断：

```javascript
// 数据库连接诊断
const db = wx.cloud.database()

// 测试1：检查云开发
console.log('☁️ 云开发对象:', wx.cloud)

// 测试2：尝试读取 tasks 集合
db.collection('tasks').limit(1).get()
  .then(res => {
    console.log('✅ tasks 集合可访问:', res)
  })
  .catch(err => {
    console.error('❌ tasks 集合访问失败:', err)
  })

// 测试3：尝试创建测试数据
db.collection('tasks').add({
  data: {
    title: '测试任务',
    priority: 'medium',
    status: 'pending',
    pomodoroTarget: 1,
    pomodoroCompleted: 0,
    createdAt: new Date()
  }
}).then(res => {
  console.log('✅ 创建测试数据成功:', res)
  // 立即尝试读取
  return db.collection('tasks').doc(res._id).get()
}).then(res => {
  console.log('✅ 读取测试数据成功:', res)
}).catch(err => {
  console.error('❌ 数据库操作失败:', err)
})
```

---

**配置完成后，记得重启小程序测试！** 🎉
